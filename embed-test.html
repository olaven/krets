<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>


    <ul id="krets-emoji-list">
        <ul class="flex-container">
            <li class="krets-flex-element">
                <div class="emoji">üòÑ</div>
            </li>
            <li class="krets-flex-element">
                <div class="emoji">üòê</div>
            </li>
            <li class="krets-flex-element">
                <div class="emoji">üòû</div>
            </li>
        </ul>
    </ul>

    <ul id="krets-questions-list">

    </ul>
    <style>
        ul {
            list-style-type: none;
            padding: 0;
        }

        .flex-container {
            position: relative;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            padding: 0 20em;
        }

        .krets-flex-element {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 5em;
            height: 5em;
            margin: 1em;
            cursor: pointer;
            flex: 1 0 auto;
            transition: .4s ease, opacity .3s ease, transform .2s ease;
            margin: 2em;
        }

        .krets-flex-element:hover {
            transform: scale(1.2);
        }

        .krets-flex-element-removed {

            flex: 0 0 auto;
            width: 0;
            border: none;
            opacity: 0;
            margin: 0;
        }

        .emoji {
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            font-size: 8em;
        }

        #krets-questions-list {
            transition: opacity ease-in .5s;
            opacity: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .krets-question-input {
            border: solid .1px;
            border-radius: 10px;
            padding: .5em;
            margin: .25em;
            font-size: 1.25em;
            width: 55%;
        }

        .krets-question-input:focus {
            outline: none;
            transition: ease .1s;
            transform: scale(1.01);
        }
    </style>

    <script>

        let useState;
        /**
         * ======================|
         * ++++-HELPERS-+++++++++|
         * ======================|
         * */


        /**
         * HOF for: 
         * returning result of query. 
         * Returns One element if ID (i.e. "#") is targeted. 
         * Returns JS if not. 
        * */
        const get = (selector) =>
            () => selector.startsWith("#") ?
                document.getElementById(selector.substring(1)) :
                Array.from(
                    document.querySelectorAll(selector)
                );

        const getEmojis = get(".krets-flex-element");
        const getQuestionContainer = get("#krets-questions-list");

        const initializeState = (initializeState) => {


            let state = initializeState || {}
            return (updates = {}) => {

                state = {
                    ...state,
                    ...updates,
                }
                return state;
            }
        }

        const loadEmbedInformation = async () => {

            const { PAGE_ID, TOKEN } = useState();
            const response = await fetch(`http://localhost:3000/api/pages/${PAGE_ID}/embeddables/information?token=${TOKEN}`);

            useState({
                information: await response.json()
            });
        }

        const showQuestions = () => {

            getQuestionContainer().style.opacity = 1;
        }

        const setupClickListeners = () => {

            const remove = (element) => element.classList.add("krets-flex-element-removed");
            const select = (element) => element.classList.add("krets-selected-emoji");

            getEmojis()
                .forEach(emoji => {
                    emoji.onclick = (event) => {

                        select(event.target);
                        showQuestions();

                        getEmojis()
                            .filter(element => element.innerText !== event.target.innerText)
                            .map(remove);
                    }
                });
        }


        const renderQuestions = () => {

            const renderQuestion = (text) => {

                const input = document.createElement("input");
                input.placeholder = text;
                input.classList.add("krets-question-input");
                input.onkeyup = event => {

                    console.log(event.target.value)
                }
                getQuestionContainer().appendChild(input);
            }

            const questions = useState().information.questions;

            if (questions.length > 0) {

                questions.forEach(question => { renderQuestion(question.text) })
            } else {

                renderQuestion("Hva likte du?");
            }
        }


        /**
         * This should not be called in code, but exposed to end user. 
         * */
        const IntializeKrets = async (PAGE_ID, TOKEN) => {

            useState = initializeState({
                PAGE_ID,
                TOKEN
            });

            setupClickListeners();
            await loadEmbedInformation();

            renderQuestions();
        }

        IntializeKrets("side", "wP48yYV4CE8sHXEDTnjsg")
    </script>


</body>

</html>
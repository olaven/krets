<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>


    <div id="krets-container">
        <ul id="krets-emoji-list">
            <ul class="flex-container">
                <li class="krets-flex-element" role="button">
                    <div class="emoji">üòÑ</div>
                </li>
                <li class="krets-flex-element" role="button">
                    <div class="emoji">üòê</div>
                </li>
                <li class="krets-flex-element" role="button">
                    <div class="emoji">üòû</div>
                </li>
            </ul>
        </ul>

        <div id="krets-optional-input-container">
            <h2 class="krets-sub-header">Valgfri utdypning</h2>
            <ul id="krets-questions-list"></ul>

            <h2 id="krets-contact-header" class="krets-sub-header">Valgfri kontaktinformasjon</h2>
            <input id="krets-contact-input" class="krets-input" type="email" placeholder="e-post eller telefonnummer" />
            <button id="krets-send-button">send</button>
        </div>
    </div>

    <style>
        ul {
            list-style-type: none;
            padding: 0;
        }

        #krets-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .krets-sub-header {

            font-size: 1em;
            opacity: .5;
            margin: 0;
            margin-top: 1em;
            margin-bottom: .25em;

        }

        .flex-container {
            position: relative;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            padding: 0 20em;
        }

        .krets-flex-element {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 5em;
            height: 5em;
            margin: 1em;
            cursor: pointer;
            flex: 1 0 auto;
            transition: .4s ease, opacity .3s ease, transform .2s ease;
            margin: 2em;
        }

        .krets-flex-element:hover {
            transform: scale(1.2);
        }

        .krets-flex-element-removed {

            flex: 0 0 auto;
            width: 0;
            border: none;
            opacity: 0;
            margin: 0;
        }

        .emoji {
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            font-size: 8em;
        }

        #krets-optional-input-container {
            display: flex;
            flex-direction: column;
            transition: opacity ease-in .5s;
            opacity: 0;
        }

        #krets-questions-list {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }


        .krets-input:hover {

            outline: none;
            transition: ease .1s;
            transform: scale(1.01);

        }

        .krets-input {
            border: solid .1px;
            border-radius: 10px;
            padding: .5em;
            font-size: 1.25em;
        }

        .krets-question-input {}

        .krets-question-input:focus {}

        #krets-contact-input {}

        #krets-send-button {

            border: none;
            margin-top: 1em;
            padding: 1em;
            padding-left: 2.5em;
            padding-right: 2.5em;
            font-size: 1.5em;
            background-color: hsl(183, 80%, 20%);
            color: white;
            border-radius: 10px;
        }

        #krets-send-button:hover {
            cursor: pointer;
            transition: transform ease .1s;
            transform: scale(1.05);
        }
    </style>

    <script>

        //TODO: UPDATE BEFORE LIVE TEST 
        const API_BASE = "http://localhost:3000/"
        let useState;

        /**
         * HOF for: 
         * returning result of query. 
         * Returns One element if ID (i.e. "#") is targeted. 
         * Returns JS if not. 
        * */
        const get = (selector) =>
            () => selector.startsWith("#") ?
                document.getElementById(selector.substring(1)) :
                Array.from(
                    document.querySelectorAll(selector)
                );


        /*GETERS FOR ELEMENTS*/
        const getEmojis = get(".krets-flex-element");
        const getOptionalInuptContainer = get("#krets-optional-input-container");
        const getQuestionContainer = get("#krets-questions-list");
        const getContactInput = get("#krets-contact-input");
        const getContactHeader = get("#krets-contact-header");
        const getSendButton = get("#krets-send-button");

        const initializeState = (initializeState) => {


            let state = initializeState || {}
            return (updates = {}) => {

                state = {
                    ...state,
                    ...updates,
                }
                return state;
            }
        }

        const loadEmbedInformation = async () => {

            const { PAGE_ID, TOKEN } = useState();
            const response = await fetch(`${API_BASE}api/pages/${PAGE_ID}/embeddables/information?token=${TOKEN}`);

            if (response.status !== 200) {
                console.error(`${response.status} when loading Krets. Perhaps the token is wrong?`);
                return;
            }

            const information = await response.json();

            if (information.mandatoryContactDetails) {
                getContactHeader().innerText = "Kontaktinformasjon"
            }

            useState({
                ...information
            });
        }

        const showOptionalInput = () => {

            getOptionalInuptContainer().style.opacity = 1;
        }


        const onSend = async () => {

            const { TOKEN, PAGE_ID, answers, emotion, contactDetails, mandatoryContactDetails } = useState();

            if (mandatoryContactDetails && !contactDetails) {

                getContactInput().style.borderColor = "red";
                return;
            }

            /*
            token: string,
            response: ResponseModel
            answers: AnswerModel[]
            */

            const embeddableResponse = {
                token: TOKEN,
                response: {
                    page_id: PAGE_ID,
                    emotion,
                    contact_details: contactDetails,
                },
                answers: answers.values()
            }

            const { status } = await fetch(`${API_BASE}/api/pages/${PAGE_ID}/embeddables`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(embeddableResponse)
            });

            console.log(status);

        }

        const setupClickListeners = () => {

            const remove = (element) => element.classList.add("krets-flex-element-removed");
            const select = (element) => {

                element.classList.add("krets-selected-emoji");

                useState({
                    emotion: {
                        "üòÑ": ":-)",
                        "üòê": ":-|",
                        "üòû": ":-(",
                    }[element.innerText],
                });
            }

            getSendButton().onclick = onSend;
            getEmojis()
                .forEach(emoji => {
                    emoji.onclick = (event) => {

                        select(event.target);
                        showOptionalInput();

                        getEmojis()
                            .filter(element => element.innerText !== event.target.innerText)
                            .map(remove);
                    }
                });
        }


        const renderQuestions = () => {

            const renderQuestion = (question) => {

                const input = document.createElement("input");
                input.placeholder = question.text;
                input.classList.add("krets-question-input", "krets-input");
                input.onkeyup = event => {

                    useState().answers.set(question.id, {
                        text: event.target.value,
                        question_id: question.id
                    });
                }
                getQuestionContainer().appendChild(input);
            }

            const { questions } = useState()

            if (questions.length > 0) {

                questions.forEach(question => { renderQuestion(question) })
            } else {

                renderQuestion({
                    text: "Dine betraktninger?"
                });
            }
        }

        const setupContactListener = () => {

            getContactInput().onkeyup = event => {

                useState({
                    contactDetails: event.target.value
                });
            }
        }


        /**
         * This should not be called in code, but exposed to end user. 
         * */
        const IntializeKrets = async (PAGE_ID, TOKEN) => {

            useState = initializeState({
                PAGE_ID,
                TOKEN,
                questions: [],
                answers: new Map(),
                mandatoryContactDetails: false
            });

            setupClickListeners();
            setupContactListener();
            await loadEmbedInformation();

            renderQuestions();
        }

        IntializeKrets("side", "wP48yYV4CE8sHXEDTnjsg")
    </script>


</body>

</html>